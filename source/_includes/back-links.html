{% comment %}
Back-links Generator
====================
Searches all collections (blog, videos, people) to find pages that link to the current page.
Also includes reciprocal back-links - pages that the current page would auto-link to.
Blog posts and videos are intermixed chronologically, followed by people.

Usage: {% include back-links.html %}
Expects page.url to be set (automatically available in layouts)
{% endcomment %}

{% assign current_url = page.url %}
{% assign current_title = page.title | default: page.name | remove: '"' | remove: "'" %}
{% assign current_name = page.name | remove: '"' | remove: "'" %}
{% assign current_alias = page.alias | remove: '"' | remove: "'" %}
{% assign content_backlinks = "" | split: "" %}
{% assign people_backlinks = "" | split: "" %}

{% comment %}
Phase 1: Traditional back-links
Search through all blog posts for references to current page
{% endcomment %}
{% for post in site.blog %}
  {% if post.url != current_url and post.hidden != true and post.hidden != 'true' %}
    {% comment %}Check if blog post content or title links to current page{% endcomment %}
    {% assign content_with_fm = post.content | append: post.title | append: post.description | remove: '"' | remove: "'" %}
    {% assign found_match = false %}
    {% if content_with_fm contains current_url %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_title and current_title != "" and content_with_fm contains current_title %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_name and current_name != "" and content_with_fm contains current_name %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_alias and current_alias != "" and content_with_fm contains current_alias %}
      {% assign found_match = true %}
    {% endif %}
    {% comment %}Check if this post is authored by the current person{% endcomment %}
    {% assign normalized_author = post.author | remove: '"' | remove: "'" %}
    {% if normalized_author and current_name and normalized_author == current_name %}
      {% assign found_match = true %}
    {% endif %}
    {% if found_match %}
      {% assign content_backlinks = content_backlinks | push: post %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Search through all videos for references to current page
{% endcomment %}
{% for video in site.videos %}
  {% if video.url != current_url %}
    {% comment %}Check video content, hosts, guests{% endcomment %}
    {% assign video_content = video.content | append: video.title | append: video.description | remove: '"' | remove: "'" %}
    {% if video.hosts %}
      {% for host in video.hosts %}
        {% assign normalized_host = host | remove: '"' | remove: "'" %}
        {% assign video_content = video_content | append: " " | append: normalized_host %}
      {% endfor %}
    {% endif %}
    {% if video.guests %}
      {% for guest in video.guests %}
        {% assign normalized_guest = guest | remove: '"' | remove: "'" %}
        {% assign video_content = video_content | append: " " | append: normalized_guest %}
      {% endfor %}
    {% endif %}
    {% assign found_match = false %}
    {% if video_content contains current_url %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_title and current_title != "" and video_content contains current_title %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_name and current_name != "" and video_content contains current_name %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_alias and current_alias != "" and video_content contains current_alias %}
      {% assign found_match = true %}
    {% endif %}
    {% if found_match %}
      {% assign content_backlinks = content_backlinks | push: video %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Search through all people for references to current page
{% endcomment %}
{% for person in site.people %}
  {% if person.url != current_url and person.hidden != true and person.hidden != 'true' %}
    {% comment %}Check person content and description{% endcomment %}
    {% assign person_content = person.content | append: person.description | append: person.name | remove: '"' | remove: "'" %}
    {% assign found_match = false %}
    {% if person_content contains current_url %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_title and current_title != "" and person_content contains current_title %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_name and current_name != "" and person_content contains current_name %}
      {% assign found_match = true %}
    {% endif %}
    {% if current_alias and current_alias != "" and person_content contains current_alias %}
      {% assign found_match = true %}
    {% endif %}
    {% if found_match %}
      {% assign people_backlinks = people_backlinks | push: person %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Phase 2: Reciprocal back-links
Find content that the current page would auto-link to, and add those as reciprocal back-links
{% endcomment %}
{% assign current_content = page.content | append: page.title | append: page.description %}
{% if page.author %}
  {% assign current_content = current_content | append: " " | append: page.author %}
{% endif %}
{% comment %}Include hosts and guests in current content for reciprocal back-links{% endcomment %}
{% if page.hosts %}
  {% for host in page.hosts %}
    {% assign current_content = current_content | append: " " | append: host %}
  {% endfor %}
{% endif %}
{% if page.guests %}
  {% for guest in page.guests %}
    {% assign current_content = current_content | append: " " | append: guest %}
  {% endfor %}
{% endif %}
{% assign current_content = current_content | remove: '"' | remove: "'" %}

{% comment %}
Find people that the current page would auto-link to
{% endcomment %}
{% for person in site.people %}
  {% if person.url != current_url and person.hidden != true and person.hidden != 'true' %}
    {% comment %}Check if current page content contains this person's name (would create auto-link){% endcomment %}
    {% assign normalized_person_name = person.name | remove: '"' | remove: "'" %}
    {% if normalized_person_name and normalized_person_name != "" and current_content contains normalized_person_name %}
      {% comment %}Add this person as a reciprocal back-link{% endcomment %}
      {% assign already_exists = false %}
      {% for existing in people_backlinks %}
        {% if existing.url == person.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless already_exists %}
        {% assign people_backlinks = people_backlinks | push: person %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Find blog posts that the current page would auto-link to
{% endcomment %}
{% assign autolink_backlinks = "" | split: "" %}
{% for post in site.blog %}
  {% if post.url != current_url and post.hidden != true and post.hidden != 'true' %}
    {% assign would_be_linked = false %}
    
    {% comment %}Check if current page would auto-link to this post by title{% endcomment %}
    {% assign normalized_post_title = post.title | remove: '"' | remove: "'" %}
    {% if normalized_post_title and normalized_post_title != "" and current_content contains normalized_post_title %}
      {% assign would_be_linked = true %}
    {% endif %}
    
    {% comment %}Check if current page would auto-link to this post by alias{% endcomment %}
    {% assign normalized_post_alias = post.alias | remove: '"' | remove: "'" %}
    {% if normalized_post_alias and normalized_post_alias != "" and current_content contains normalized_post_alias %}
      {% assign would_be_linked = true %}
    {% endif %}
    
    {% if would_be_linked %}
      {% comment %}Check if this post isn't already in the backlinks{% endcomment %}
      {% assign already_exists = false %}
      {% for existing in content_backlinks %}
        {% if existing.url == post.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless already_exists %}
        {% assign autolink_backlinks = autolink_backlinks | push: post %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Find videos that the current page would auto-link to
{% endcomment %}
{% for video in site.videos %}
  {% if video.url != current_url %}
    {% comment %}Check if current page would auto-link to this video by title{% endcomment %}
    {% assign normalized_video_title = video.title | remove: '"' | remove: "'" %}
    {% if normalized_video_title and normalized_video_title != "" and current_content contains normalized_video_title %}
      {% comment %}Check if this video isn't already in the backlinks{% endcomment %}
      {% assign already_exists = false %}
      {% for existing in content_backlinks %}
        {% if existing.url == video.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% for existing in autolink_backlinks %}
        {% if existing.url == video.url %}
          {% assign already_exists = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% unless already_exists %}
        {% assign autolink_backlinks = autolink_backlinks | push: video %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %}
Merge auto-link back-links with content back-links and sort chronologically
{% endcomment %}
{% assign all_content_backlinks = content_backlinks | concat: autolink_backlinks %}
{% assign sorted_content = all_content_backlinks | sort: "date" %}

{% comment %}
Display back-links section if any were found
{% endcomment %}
{% assign total_backlinks = all_content_backlinks.size | plus: people_backlinks.size %}
{% if total_backlinks > 0 %}
<div class="back-links-section">
  <h2>Back-links</h2>
  <p class="back-links-description">Other pages that reference this:</p>
  <ul class="back-links-list">
    {% comment %}First display blog posts and videos in chronological order{% endcomment %}
    {% for backlink in sorted_content %}
    <li>
      <a href="{{ backlink.url | relative_url }}">{{ backlink.title | default: backlink.name }}</a>
      {% if backlink.collection %}
        <span class="back-link-type">({{ backlink.collection | slice: 0 | upcase }}{{ backlink.collection | slice: 1, 20 }}{% if backlink.date %}, {{ backlink.date | date: "%B %d, %Y" }}{% endif %})</span>
      {% endif %}
    </li>
    {% endfor %}
    
    {% comment %}Then display people alphabetically{% endcomment %}
    {% assign sorted_people = people_backlinks | sort: "name" %}
    {% for backlink in sorted_people %}
    <li>
      <a href="{{ backlink.url | relative_url }}">{{ backlink.title | default: backlink.name }}</a>
      {% if backlink.collection %}
        <span class="back-link-type">({{ backlink.collection | slice: 0 | upcase }}{{ backlink.collection | slice: 1, 20 }})</span>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}
